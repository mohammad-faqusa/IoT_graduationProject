<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Device Dashboard</title>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2196f3;
            --secondary-color: #03a9f4;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --dark-color: #333;
            --light-color: #f4f4f4;
            --text-color: #333;
            --text-light: #f4f4f4;
            --border-color: #ddd;
            --card-bg: white;
            --body-bg: #f0f2f5;
            --header-bg: white;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dark-theme {
            --primary-color: #2196f3;
            --secondary-color: #0288d1;
            --success-color: #43a047;
            --warning-color: #fb8c00;
            --danger-color: #e53935;
            --dark-color: #222;
            --light-color: #444;
            --text-color: #eee;
            --text-light: #eee;
            --border-color: #555;
            --card-bg: #333;
            --body-bg: #222;
            --header-bg: #333;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--body-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        header {
            background-color: var(--header-bg);
            padding: 15px 20px;
            box-shadow: var(--shadow);
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .device-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .device-icon {
            width: 50px;
            height: 50px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
        }

        .device-details h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--success-color);
        }

        .status-indicator.offline {
            background-color: var(--danger-color);
        }

        .status-indicator.warning {
            background-color: var(--warning-color);
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-color);
        }

        /* Dashboard Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-grid .card {
            grid-column: span 1;
        }

        .dashboard-grid .card.wide {
            grid-column: span 2;
        }

        @media (max-width: 768px) {
            .dashboard-grid .card.wide {
                grid-column: span 1;
            }
        }

        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .card-content {
            min-height: 200px;
        }

        /* Chart Container */
        .chart-container {
            width: 100%;
            height: 250px;
        }

        /* Gauge Styles */
        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
        }

        .gauge {
            width: 150px;
            height: 75px;
            border-radius: 75px 75px 0 0;
            background-color: #eee;
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .gauge-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background-color: var(--primary-color);
            transition: height 0.5s;
        }

        .gauge-value {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            font-weight: bold;
        }

        .gauge-label {
            font-size: 14px;
            margin-top: 40px;
            color: var(--text-color);
        }

        /* Control Panel Styles */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .control-label {
            font-size: 14px;
            font-weight: 600;
        }

        /* Button Styles */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--success-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Range Slider */
        .range-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 10px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .range-value {
            text-align: center;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Event Log Styles */
        .event-log {
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.info {
            border-left: 3px solid var(--primary-color);
        }

        .log-entry.warning {
            border-left: 3px solid var(--warning-color);
        }

        .log-entry.error {
            border-left: 3px solid var(--danger-color);
        }

        .log-entry.success {
            border-left: 3px solid var(--success-color);
        }

        .log-time {
            color: #777;
            font-size: 12px;
        }

        /* Settings Panel */
        .settings-form {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            align-items: center;
        }

        .settings-form label {
            font-weight: 600;
        }

        .settings-form input, .settings-form select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .settings-actions {
            grid-column: span 2;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .device-info, .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .header-actions {
                margin-top: 15px;
            }

            .settings-form {
                grid-template-columns: 1fr;
            }

            .settings-actions {
                grid-column: span 1;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            background-color: var(--success-color);
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transform: translateX(150%);
            transition: transform 0.3s;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
        }

        /* Loading Spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            background-color: var(--success-color);
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .connection-status.disconnected {
            background-color: var(--danger-color);
        }

        .connection-status.connecting {
            background-color: var(--warning-color);
        }

        .connection-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: white;
        }

        .connection-status.disconnected .connection-indicator {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Dynamic Component Styles */
        .component-library {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .component-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .component-item:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-3px);
        }

        .component-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .component-name {
            font-size: 12px;
            font-weight: 600;
        }

        /* Circle Canvas */
        .circle-canvas {
            width: 150px;
            height: 150px;
            margin: 0 auto;
        }

        /* On/Off Indicator */
        .onoff-indicator {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            transition: background-color 0.3s;
        }

        .onoff-indicator.on {
            background-color: var(--success-color);
        }

        .onoff-indicator.off {
            background-color: var(--danger-color);
        }

        /* Text Display */
        .text-display {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.05);
            min-height: 60px;
            word-break: break-word;
        }

        /* Automation Panel */
        .automation-rule {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .automation-rule select, 
        .automation-rule input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .delete-rule {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Component Configuration Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .config-form {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            align-items: center;
        }

        .config-form label {
            font-weight: 600;
        }

        .config-form input, 
        .config-form select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        /* Drag and Drop */
        .draggable {
            cursor: move;
        }

        .drag-handle {
            cursor: move;
            padding: 5px;
            margin-right: 5px;
        }

        .dropzone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            color: #777;
        }

        .dropzone.drag-over {
            background-color: rgba(33, 150, 243, 0.1);
            border-color: var(--primary-color);
        }

        /* Component Toolbar */
        .component-toolbar {
            background-color: var(--header-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .toolbar-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="device-info">
                <div class="device-icon">D</div>
                <div class="device-details">
                    <h1>Smart Device Control Panel</h1>
                    <div class="device-status">
                        <div class="status-indicator" id="statusIndicator"></div>
                        <span id="statusText">Connecting...</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button id="editModeBtn" class="btn btn-secondary">Edit Dashboard</button>
                <button id="refreshBtn" class="btn btn-primary">Refresh Data</button>
                <button id="themeToggle" class="theme-toggle">🌙</button>
            </div>
        </header>

        <!-- Component Toolbar (visible in edit mode) -->
        <div class="component-toolbar" id="componentToolbar" style="display: none;">
            <div class="toolbar-title">Add Components</div>
            
            <div class="tabs">
                <div class="tab active" data-tab="display">Display</div>
                <div class="tab" data-tab="control">Control</div>
                <div class="tab" data-tab="automation">Automation</div>
            </div>
            
            <div class="tab-content active" data-tab-content="display">
                <div class="component-library">
                    <div class="component-item" data-component="text-display">
                        <div class="component-icon">📝</div>
                        <div class="component-name">Text Display</div>
                    </div>
                    <div class="component-item" data-component="circle-canvas">
                        <div class="component-icon">⭕</div>
                        <div class="component-name">Circle Canvas</div>
                    </div>
                    <div class="component-item" data-component="onoff-indicator">
                        <div class="component-icon">🔘</div>
                        <div class="component-name">On/Off Indicator</div>
                    </div>
                    <div class="component-item" data-component="gauge">
                        <div class="component-icon">🌡️</div>
                        <div class="component-name">Gauge</div>
                    </div>
                    <div class="component-item" data-component="chart">
                        <div class="component-icon">📊</div>
                        <div class="component-name">Chart</div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" data-tab-content="control">
                <div class="component-library">
                    <div class="component-item" data-component="text-input">
                        <div class="component-icon">✏️</div>
                        <div class="component-name">Text Input</div>
                    </div>
                    <div class="component-item" data-component="switch-button">
                        <div class="component-icon">🔄</div>
                        <div class="component-name">Switch Button</div>
                    </div>
                    <div class="component-item" data-component="slider">
                        <div class="component-icon">🎚️</div>
                        <div class="component-name">Slider</div>
                    </div>
                    <div class="component-item" data-component="select-dropdown">
                        <div class="component-icon">📋</div>
                        <div class="component-name">Select Dropdown</div>
                    </div>
                    <div class="component-item" data-component="push-button">
                        <div class="component-icon">🔘</div>
                        <div class="component-name">Push Button</div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" data-tab-content="automation">
                <div class="component-library">
                    <div class="component-item" data-component="automation-rule">
                        <div class="component-icon">⚙️</div>
                        <div class="component-name">Automation Rule</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid" id="dashboardGrid">
            <!-- Temperature Chart -->
            <div class="card wide" data-component-id="temp-chart">
                <div class="card-header">
                    <div class="card-title">Temperature History</div>
                    <div class="card-actions">
                        <button class="btn btn-secondary" id="tempTimeRange">Last Hour</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- CPU Usage Gauge -->
            <div class="card" data-component-id="cpu-gauge">
                <div class="card-header">
                    <div class="card-title">CPU Usage</div>
                    <div class="card-actions">
                        <span id="cpuStatus" class="status-text">Normal</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="gauge-container">
                        <div class="gauge">
                            <div class="gauge-fill" id="cpuGaugeFill"></div>
                            <div class="gauge-value" id="cpuGaugeValue">0%</div>
                        </div>
                        <div class="gauge-label">Current CPU Load</div>
                    </div>
                </div>
            </div>

            <!-- Memory Usage Gauge -->
            <div class="card" data-component-id="memory-gauge">
                <div class="card-header">
                    <div class="card-title">Memory Usage</div>
                    <div class="card-actions">
                        <span id="memoryStatus" class="status-text">Normal</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="gauge-container">
                        <div class="gauge">
                            <div class="gauge-fill" id="memoryGaugeFill"></div>
                            <div class="gauge-value" id="memoryGaugeValue">0%</div>
                        </div>
                        <div class="gauge-label">Current Memory Usage</div>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="card wide" data-component-id="device-controls">
                <div class="card-header">
                    <div class="card-title">Device Controls</div>
                    <div class="card-actions">
                        <button class="btn btn-success" id="saveControlsBtn">Save Settings</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="control-panel">
                        <!-- Power Toggle -->
                        <div class="control-item">
                            <span class="control-label">Power</span>
                            <label class="switch">
                                <input type="checkbox" id="powerToggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <!-- Fan Speed -->
                        <div class="control-item">
                            <span class="control-label">Fan Speed</span>
                            <input type="range" min="0" max="100" value="50" class="range-slider" id="fanSpeedSlider">
                            <div class="range-value" id="fanSpeedValue">50%</div>
                        </div>

                        <!-- Mode Selection -->
                        <div class="control-item">
                            <span class="control-label">Mode</span>
                            <select id="modeSelect" class="btn">
                                <option value="auto">Auto</option>
                                <option value="performance">Performance</option>
                                <option value="eco">Eco</option>
                                <option value="quiet">Quiet</option>
                            </select>
                        </div>

                        <!-- Restart Button -->
                        <div class="control-item">
                            <span class="control-label">Restart</span>
                            <button class="btn btn-warning" id="restartBtn">Restart Device</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Event Log -->
            <div class="card wide" data-component-id="event-log">
                <div class="card-header">
                    <div class="card-title">Event Log</div>
                    <div class="card-actions">
                        <button class="btn btn-secondary" id="clearLogBtn">Clear Log</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="event-log" id="eventLog">
                        <!-- Log entries will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Automation Panel -->
            <div class="card wide" data-component-id="automation-panel">
                <div class="card-header">
                    <div class="card-title">Automation Rules</div>
                    <div class="card-actions">
                        <button class="btn btn-primary" id="addRuleBtn">Add Rule</button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="automationRules">
                        <!-- Automation rules will be added here -->
                        <div class="automation-rule">
                            <select class="input-device">
                                <option value="">Select Input</option>
                                <option value="temperature">Temperature</option>
                                <option value="cpuUsage">CPU Usage</option>
                                <option value="memoryUsage">Memory Usage</option>
                            </select>
                            <select class="condition">
                                <option value="gt">Greater Than</option>
                                <option value="lt">Less Than</option>
                                <option value="eq">Equal To</option>
                            </select>
                            <input type="number" class="threshold" value="80">
                            <select class="output-action">
                                <option value="">Select Action</option>
                                <option value="power">Toggle Power</option>
                                <option value="fanSpeed">Set Fan Speed</option>
                                <option value="mode">Change Mode</option>
                            </select>
                            <input type="text" class="action-value" placeholder="Value">
                            <button class="delete-rule">×</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Component Configuration Modal -->
    <div class="modal" id="configModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Configure Component</div>
                <button class="close-modal" id="closeModal">×</button>
            </div>
            <div class="modal-body">
                <form id="configForm" class="config-form">
                    <!-- Configuration fields will be added dynamically -->
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelConfig">Cancel</button>
                <button class="btn btn-primary" id="saveConfig">Save</button>
            </div>
        </div>
    </div>

    <!-- Connection Status Indicator -->
    <div class="connection-status connecting" id="connectionStatus">
        <div class="connection-indicator"></div>
        <span>Connecting...</span>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        Settings saved successfully!
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const themeToggle = document.getElementById('themeToggle');
            const refreshBtn = document.getElementById('refreshBtn');
            const tempTimeRange = document.getElementById('tempTimeRange');
            const cpuGaugeFill = document.getElementById('cpuGaugeFill');
            const cpuGaugeValue = document.getElementById('cpuGaugeValue');
            const cpuStatus = document.getElementById('cpuStatus');
            const memoryGaugeFill = document.getElementById('memoryGaugeFill');
            const memoryGaugeValue = document.getElementById('memoryGaugeValue');
            const memoryStatus = document.getElementById('memoryStatus');
            const powerToggle = document.getElementById('powerToggle');
            const fanSpeedSlider = document.getElementById('fanSpeedSlider');
            const fanSpeedValue = document.getElementById('fanSpeedValue');
            const modeSelect = document.getElementById('modeSelect');
            const restartBtn = document.getElementById('restartBtn');
            const clearLogBtn = document.getElementById('clearLogBtn');
            const eventLog = document.getElementById('eventLog');
            const saveControlsBtn = document.getElementById('saveControlsBtn');
            const connectionStatus = document.getElementById('connectionStatus');
            const notification = document.getElementById('notification');
            const dashboardGrid = document.getElementById('dashboardGrid');
            const editModeBtn = document.getElementById('editModeBtn');
            const componentToolbar = document.getElementById('componentToolbar');
            const configModal = document.getElementById('configModal');
            const closeModal = document.getElementById('closeModal');
            const configForm = document.getElementById('configForm');
            const modalTitle = document.getElementById('modalTitle');
            const saveConfig = document.getElementById('saveConfig');
            const cancelConfig = document.getElementById('cancelConfig');
            const addRuleBtn = document.getElementById('addRuleBtn');
            const automationRules = document.getElementById('automationRules');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            // State variables
            let isDarkTheme = false;
            let isConnected = false;
            let isEditMode = false;
            let socket = null;
            let temperatureData = [];
            let temperatureChart = null;
            let updateIntervalId = null;
            let reconnectAttempts = 0;
            let currentDeviceData = {};
            let currentComponent = null;
            const maxReconnectAttempts = 5;
            let deviceSettings = {
                name: 'Smart Device',
                updateInterval: 10,
                alertThreshold: 80,
                autoRestart: false
            };

            // Component templates
            const componentTemplates = {
                'text-display': {
                    title: 'Text Display',
                    content: `
                        <div class="text-display" data-source="temperature">
                            Waiting for data...
                        </div>
                    `,
                    config: [
                        { name: 'title', type: 'text', label: 'Title', default: 'Text Display' },
                        { name: 'source', type: 'select', label: 'Data Source', 
                          options: [
                              { value: 'temperature', label: 'Temperature' },
                              { value: 'cpuUsage', label: 'CPU Usage' },
                              { value: 'memoryUsage', label: 'Memory Usage' },
                              { value: 'fanSpeed', label: 'Fan Speed' },
                              { value: 'mode', label: 'Mode' }
                          ],
                          default: 'temperature'
                        },
                        { name: 'format', type: 'text', label: 'Format String', default: '{value}' }
                    ]
                },
                'circle-canvas': {
                    title: 'Circle Canvas',
                    content: `
                        <canvas class="circle-canvas" data-source="cpuUsage" data-min="0" data-max="100"></canvas>
                    `,
                    config: [
                        { name: 'title', type: 'text', label: 'Title', default: 'Circle Canvas' },
                        { name: 'source', type: 'select', label: 'Data Source', 
                          options: [
                              { value: 'temperature', label: 'Temperature' },
                              { value: 'cpuUsage', label: 'CPU Usage' },
                              { value: 'memoryUsage', label: 'Memory Usage' }
                          ],
                          default: 'cpuUsage'
                        },
                        { name: 'min', type: 'number', label: 'Minimum Value', default: 0 },
                        { name: 'max', type: 'number', label: 'Maximum Value', default: 100 },
                        { name: 'colorMin', type: 'color', label: 'Min Color', default: '#4caf50' },
                        { name: 'colorMax', type: 'color', label: 'Max Color', default: '#f44336' }
                    ]
                },
                'onoff-indicator': {
                    title: 'On/Off Indicator',
                    content: `
                        <div class="onoff-indicator off" data-source="power">
                            OFF
                        </div>
                    `,
                    config: [
                        { name: 'title', type: 'text', label: 'Title', default: 'On/Off Indicator' },
                        { name: 'source', type: 'select', label: 'Data Source', 
                          options: [
                              { value: 'power', label: 'Power' },
                              { value: 'networkStatus', label: 'Network Status' }
                          ],
                          default: 'power'
                        },
                        { name: 'onText', type: 'text', label: 'On Text', default: 'ON' },
                        { name: 'offText', type: 'text', label: 'Off Text', default: 'OFF' }
                    ]
                },
                'gauge': {
                    title: 'Gauge',
                    content: `
                        <div class="gauge-container">
                            <div class="gauge">
                                <div class="gauge-fill" style="height: 0%"></div>
                                <div class="gauge-value">0%</div>
                            </div>
                            <div class="gauge-label">Value</div>
                        </div>
                    `,
                    config: [
                        { name: 'title', type: 'text', label: 'Title', default: 'Gauge' },
                        { name: 'source', type: 'select', label: 'Data Source', 
                          options: [
                              { value: 'temperature', label: 'Temperature' },
                              { value: 'cpuUsage', label: 'CPU Usage' },
                              { value: 'memoryUsage', label: 'Memory Usage' },
                              { value: 'fanSpeed', label: 'Fan Speed' }
                          ],
                          default: 'cpuUsage'
                        },
                        { name: 'label', type: 'text', label: 'Label', default: 'Value' },
                        { name: 'min', type: 'number', label: 'Minimum Value', default: 0 },
                        { name: 'max', type: 'number', label: 'Maximum Value', default: 100 }
                    ]
                },
                'chart': {
                    title: 'Chart',
                    content: `
                        <div class="chart-container">
                            <canvas></canvas>
                        </div>
                    `,
                    config: [
                        { name: 'title', type: 'text', label: 'Title', default: 'Chart' },
                        { name: 'source', type: 'select', label: 'Data Source', 
                          options: [
                              { value: 'temperature', label: 'Temperature' },
                              { value: 'cpuUsage', label: 'CPU Usage' },
                              { value: 'memoryUsage', label: 'Memory Usage' }
                          ],
                          default: 'temperature'
                        },
                        { name: 'chartType', type: 'select', label: 'Chart Type', 
                          options: [
                              { value: 'line', label: 'Line' },
                              { value: 'bar', label: 'Bar' }
                          ],
                          default: 'line'
                        },
                        { name: 'timeRange', type: 'select', label: 'Time Range', 
                          options: [
                              { value: '5', label: '5 minutes' },
                              { value: '10', label: '10 minutes' },
                              { value: '30', label: '30 minutes' },
                              { value: '60', label: '1 hour' }
                          ],
                          default: '10'
                        }
                    ]
                },
                'text-input': {
                    title: 'Text Input',
                    content: `
                        <div class="control-item">
                            <span class="control-label">Input</span>
                            <input type="text" class="text-input" data-target="customCommand">
                        </div>
                    `,
                    config: [
                        { name: 'title', type: 'text', label: 'Title', default: 'Text Input' },
                        { name: 'label', type: 'text', label: 'Label', default: 'Input' },
                        { name: 'placeholder', type: 'text', label: 'Placeholder', default: 'Enter text...' },
                        { name: 'target', type: 'text', label: 'Target Command', default: 'customCommand' }
                    ]
                },
                'switch-button': {
                    title: 'Switch Button',
                    content: `
                        <div class="control-item">
                            <span class="control-label">Switch</span>
                            <label class="switch">
                                <input type="checkbox" data-target="power">
                                <span class="slider"></span>
                            </label>
                        </div>
                    `,
                    config: [
                        { name: 'title', type: 'text', label: 'Title', default: 'Switch Button' },
                        { name: 'label', type: 'text', label: 'Label', default: 'Switch' },
                        { name: 'target', type: 'select', label: 'Target Command', 
                          options: [
                              { value: 'power', label: 'Power' },
                              { value: 'autoRestart', label: 'Auto Restart' }
                          ],
                          default: 'power'
                        },
                        { name: 'defaultState', type: 'checkbox', label: 'Default State', default: false }
                    ]
                },
                'slider': {
                    title: 'Slider',
                    content: `
                        <div class="control-item">
                            <span class="control-label">Slider</span>
                            <input type="range" min="0" max="100" value="50" class="range-slider" data-target="fanSpeed">
                            <div class="range-value">50%</div>
                        </div>
                    `,
                    config: [
                        { name: 'title', type: 'text', label: 'Title', default: 'Slider' },
                        { name: 'label', type: 'text', label: 'Label', default: 'Slider' },
                        { name: 'min', type: 'number', label: 'Minimum Value', default: 0 },
                        { name: 'max', type: 'number', label: 'Maximum Value', default: 100 },
                        { name: 'default', type: 'number', label: 'Default Value', default: 50 },
                        { name: 'target', type: 'select', label: 'Target Command', 
                          options: [
                              { value: 'fanSpeed', label: 'Fan Speed' },
                              { value: 'brightness', label: 'Brightness' },
                              { value: 'volume', label: 'Volume' }
                          ],
                          default: 'fanSpeed'
                        }
                    ]
                },
                'select-dropdown': {
                    title: 'Select Dropdown',
                    content: `
                        <div class="control-item">
                            <span class="control-label">Select</span>
                            <select class="btn" data-target="mode">
                                <option value="auto">Auto</option>
                                <option value="performance">Performance</option>
                                <option value="eco">Eco</option>
                            </select>
                        </div>
                    `,
                    config: [
                        { name: 'title', type: 'text', label: 'Title', default: 'Select Dropdown' },
                        { name: 'label', type: 'text', label: 'Label', default: 'Select' },
                        { name: 'options', type: 'textarea', label: 'Options (one per line, value:label)', 
                          default: 'auto:Auto\nperformance:Performance\neco:Eco' },
                        { name: 'target', type: 'text', label: 'Target Command', default: 'mode' }
                    ]
                },
                'push-button': {
                    title: 'Push Button',
                    content: `
                        <div class="control-item">
                            <span class="control-label">Button</span>
                            <button class="btn btn-primary" data-target="restart">Press</button>
                        </div>
                    `,
                    config: [
                        { name: 'title', type: 'text', label: 'Title', default: 'Push Button' },
                        { name: 'label', type: 'text', label: 'Label', default: 'Button' },
                        { name: 'buttonText', type: 'text', label: 'Button Text', default: 'Press' },
                        { name: 'buttonStyle', type: 'select', label: 'Button Style', 
                          options: [
                              { value: 'btn-primary', label: 'Primary' },
                              { value: 'btn-secondary', label: 'Secondary' },
                              { value: 'btn-success', label: 'Success' },
                              { value: 'btn-warning', label: 'Warning' },
                              { value: 'btn-danger', label: 'Danger' }
                          ],
                          default: 'btn-primary'
                        },
                        { name: 'target', type: 'text', label: 'Target Command', default: 'restart' },
                        { name: 'confirm', type: 'checkbox', label: 'Require Confirmation', default: false }
                    ]
                },
                'automation-rule': {
                    title: 'Automation Rule',
                    content: `
                        <div class="automation-rule">
                            <select class="input-device">
                                <option value="">Select Input</option>
                                <option value="temperature">Temperature</option>
                                <option value="cpuUsage">CPU Usage</option>
                                <option value="memoryUsage">Memory Usage</option>
                            </select>
                            <select class="condition">
                                <option value="gt">Greater Than</option>
                                <option value="lt">Less Than</option>
                                <option value="eq">Equal To</option>
                            </select>
                            <input type="number" class="threshold" value="80">
                            <select class="output-action">
                                <option value="">Select Action</option>
                                <option value="power">Toggle Power</option>
                                <option value="fanSpeed">Set Fan Speed</option>
                                <option value="mode">Change Mode</option>
                            </select>
                            <input type="text" class="action-value" placeholder="Value">
                            <button class="delete-rule">×</button>
                        </div>
                    `,
                    config: [
                        { name: 'inputDevice', type: 'select', label: 'Input Device', 
                          options: [
                              { value: 'temperature', label: 'Temperature' },
                              { value: 'cpuUsage', label: 'CPU Usage' },
                              { value: 'memoryUsage', label: 'Memory Usage' }
                          ],
                          default: 'cpuUsage'
                        },
                        { name: 'condition', type: 'select', label: 'Condition', 
                          options: [
                              { value: 'gt', label: 'Greater Than' },
                              { value: 'lt', label: 'Less Than' },
                              { value: 'eq', label: 'Equal To' }
                          ],
                          default: 'gt'
                        },
                        { name: 'threshold', type: 'number', label: 'Threshold', default: 80 },
                        { name: 'outputAction', type: 'select', label: 'Output Action', 
                          options: [
                              { value: 'power', label: 'Toggle Power' },
                              { value: 'fanSpeed', label: 'Set Fan Speed' },
                              { value: 'mode', label: 'Change Mode' }
                          ],
                          default: 'fanSpeed'
                        },
                        { name: 'actionValue', type: 'text', label: 'Action Value', default: '100' }
                    ]
                }
            };

            // Initialize the dashboard
            initializeDashboard();

            // Theme Toggle
            themeToggle.addEventListener('click', function() {
                toggleTheme();
            });

            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding content
                    tabContents.forEach(content => {
                        if (content.getAttribute('data-tab-content') === tabName) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                });
            });

            // Edit Mode Toggle
            editModeBtn.addEventListener('click', function() {
                toggleEditMode();
            });

            // Component Item Click
            document.querySelectorAll('.component-item').forEach(item => {
                item.addEventListener('click', function() {
                    const componentType = this.getAttribute('data-component');
                    addComponent(componentType);
                });
            });

            // Close Modal
            closeModal.addEventListener('click', function() {
                configModal.classList.remove('show');
            });

            // Cancel Config
            cancelConfig.addEventListener('click', function() {
                configModal.classList.remove('show');
            });

            // Save Config
            saveConfig.addEventListener('click', function() {
                saveComponentConfig();
            });

            // Add Rule Button
            addRuleBtn.addEventListener('click', function() {
                addAutomationRule();
            });

            // Initialize the dashboard
            function initializeDashboard() {
                // Initialize charts
                initializeTemperatureChart();
                
                // Connect to WebSocket
                connectWebSocket();
                
                // Set up event listeners
                setupEventListeners();
                
                // Add initial log entry
                addLogEntry('Dashboard initialized', 'info');
                
                // Check for saved theme preference
                checkThemePreference();
                
                // Initialize dynamic components
                initializeDynamicComponents();
            }

            // Initialize Temperature Chart
            function initializeTemperatureChart() {
                const ctx = document.getElementById('temperatureChart').getContext('2d');
                
                // Generate initial data
                const labels = Array.from({length: 12}, (_, i) => {
                    const date = new Date();
                    date.setMinutes(date.getMinutes() - (11 - i) * 5);
                    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                });
                
                const data = Array.from({length: 12}, () => Math.floor(Math.random() * 15) + 20);
                temperatureData = data;
                
                temperatureChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Temperature (°C)',
                            data: data,
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 15,
                                max: 45,
                                ticks: {
                                    stepSize: 5
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Connect to WebSocket
            function connectWebSocket() {
                // For demonstration, we'll simulate WebSocket connection
                connectionStatus.className = 'connection-status connecting';
                connectionStatus.innerHTML = '<div class="connection-indicator"></div><span>Connecting...</span>';
                
                // Simulate connection process
                setTimeout(() => {
                    // In a real application, you would use:
                    // socket = new WebSocket('ws://your-server-url');
                    
                    // For demo, we'll create a mock socket
                    socket = createMockWebSocket();
                    
                    // Update connection status
                    isConnected = true;
                    connectionStatus.className = 'connection-status';
                    connectionStatus.innerHTML = '<div class="connection-indicator"></div><span>Connected</span>';
                    
                    // Update device status
                    statusIndicator.className = 'status-indicator';
                    statusText.textContent = 'Online';
                    
                    // Add log entry
                    addLogEntry('Connected to device', 'success');
                    
                    // Start data updates
                    startDataUpdates();
                }, 2000);
            }

            // Create a mock WebSocket for demonstration
            function createMockWebSocket() {
                const mockSocket = {
                    send: function(data) {
                        console.log('Sent data:', data);
                        
                        // Simulate receiving a response
                        const message = JSON.parse(data);
                        
                        setTimeout(() => {
                            if (message.type === 'command') {
                                this.onmessage({
                                    data: JSON.stringify({
                                        type: 'commandResponse',
                                        command: message.command,
                                        status: 'success',
                                        message: `Command ${message.command} executed successfully`
                                    })
                                });
                            }
                        }, 500);
                    },
                    close: function() {
                        console.log('WebSocket closed');
                    },
                    onmessage: null,
                    onclose: null,
                    onerror: null
                };
                
                return mockSocket;
            }

            // Start periodic data updates
            function startDataUpdates() {
                // Clear any existing interval
                if (updateIntervalId) {
                    clearInterval(updateIntervalId);
                }
                
                // Immediately update once
                updateDeviceData();
                
                // Set interval for updates
                updateIntervalId = setInterval(updateDeviceData, deviceSettings.updateInterval * 1000);
            }

            // Update device data
            function updateDeviceData() {
                if (!isConnected) return;
                
                // Simulate receiving data from the device
                const data = generateMockDeviceData();
                
                // Store current data
                currentDeviceData = data;
                
                // Process the received data
                processDeviceData(data);
                
                // Update dynamic components
                updateDynamicComponents(data);
                
                // Check automation rules
                checkAutomationRules(data);
            }

            // Generate mock device data for demonstration
            function generateMockDeviceData() {
                // Generate random values for demonstration
                const now = new Date();
                const temperature = Math.floor(Math.random() * 15) + 20; // 20-35°C
                const cpuUsage = Math.floor(Math.random() * 60) + 20; // 20-80%
                const memoryUsage = Math.floor(Math.random() * 50) + 30; // 30-80%
                const fanSpeed = parseInt(fanSpeedSlider.value);
                const mode = modeSelect.value;
                const isPoweredOn = powerToggle.checked;
                
                return {
                    timestamp: now,
                    temperature: temperature,
                    cpuUsage: cpuUsage,
                    memoryUsage: memoryUsage,
                    fanSpeed: fanSpeed,
                    mode: mode,
                    power: isPoweredOn,
                    diskSpace: {
                        total: 512,
                        used: Math.floor(Math.random() * 300) + 100
                    },
                    networkStatus: {
                        upload: Math.floor(Math.random() * 10) + 1,
                        download: Math.floor(Math.random() * 20) + 5,
                        connected: Math.random() > 0.1 // 90% chance of being connected
                    }
                };
            }

            // Process device data
            function processDeviceData(data) {
                // Update temperature chart
                updateTemperatureChart(data.temperature);
                
                // Update CPU gauge
                updateCpuGauge(data.cpuUsage);
                
                // Update memory gauge
                updateMemoryGauge(data.memoryUsage);
                
                // Check for alerts
                checkAlerts(data);
                
                // Add log entry for significant changes
                if (data.cpuUsage > deviceSettings.alertThreshold || 
                    data.memoryUsage > deviceSettings.alertThreshold) {
                    addLogEntry(`High resource usage detected - CPU: ${data.cpuUsage}%, Memory: ${data.memoryUsage}%`, 'warning');
                }
            }

            // Update temperature chart
            function updateTemperatureChart(temperature) {
                // Add new data point
                temperatureData.push(temperature);
                if (temperatureData.length > 12) {
                    temperatureData.shift();
                }
                
                // Update labels
                const now = new Date();
                const newLabel = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                temperatureChart.data.labels.push(newLabel);
                if (temperatureChart.data.labels.length > 12) {
                    temperatureChart.data.labels.shift();
                }
                
                // Update dataset
                temperatureChart.data.datasets[0].data = temperatureData;
                
                // Update chart
                temperatureChart.update();
            }

            // Update CPU gauge
            function updateCpuGauge(cpuUsage) {
                // Update gauge fill height (0-100%)
                const fillHeight = cpuUsage + '%';
                cpuGaugeFill.style.height = fillHeight;
                
                // Update gauge value text
                cpuGaugeValue.textContent = cpuUsage + '%';
                
                // Update status text based on usage
                if (cpuUsage < 50) {
                    cpuStatus.textContent = 'Normal';
                    cpuGaugeFill.style.backgroundColor = 'var(--success-color)';
                } else if (cpuUsage < 80) {
                    cpuStatus.textContent = 'Moderate';
                    cpuGaugeFill.style.backgroundColor = 'var(--warning-color)';
                } else {
                    cpuStatus.textContent = 'High';
                    cpuGaugeFill.style.backgroundColor = 'var(--danger-color)';
                }
            }

            // Update memory gauge
            function updateMemoryGauge(memoryUsage) {
                // Update gauge fill height (0-100%)
                const fillHeight = memoryUsage + '%';
                memoryGaugeFill.style.height = fillHeight;
                
                // Update gauge value text
                memoryGaugeValue.textContent = memoryUsage + '%';
                
                // Update status text based on usage
                if (memoryUsage < 50) {
                    memoryStatus.textContent = 'Normal';
                    memoryGaugeFill.style.backgroundColor = 'var(--success-color)';
                } else if (memoryUsage < 80) {
                    memoryStatus.textContent = 'Moderate';
                    memoryGaugeFill.style.backgroundColor = 'var(--warning-color)';
                } else {
                    memoryStatus.textContent = 'High';
                    memoryGaugeFill.style.backgroundColor = 'var(--danger-color)';
                }
            }

            // Check for alerts
            function checkAlerts(data) {
                // Check if any values exceed thresholds
                if (data.cpuUsage > deviceSettings.alertThreshold) {
                    showNotification(`Warning: CPU usage is high (${data.cpuUsage}%)`, 'warning');
                }
                
                if (data.memoryUsage > deviceSettings.alertThreshold) {
                    showNotification(`Warning: Memory usage is high (${data.memoryUsage}%)`, 'warning');
                }
                
                if (data.temperature > 35) {
                    showNotification(`Warning: Temperature is high (${data.temperature}°C)`, 'warning');
                }
                
                // Auto-restart if enabled and CPU usage is very high
                if (deviceSettings.autoRestart && data.cpuUsage > 90) {
                    addLogEntry('Auto-restart triggered due to high CPU usage', 'warning');
                    restartDevice();
                }
            }

            // Add entry to event log
            function addLogEntry(message, type = 'info') {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                
                logEntry.innerHTML = `
                    <div class="log-message">${message}</div>
                    <div class="log-time">${timeString}</div>
                `;
                
                eventLog.prepend(logEntry);
                
                // Limit log entries to 50
                if (eventLog.children.length > 50) {
                    eventLog.removeChild(eventLog.lastChild);
                }
            }

            // Show notification
            function showNotification(message, type = 'success') {
                notification.textContent = message;
                notification.className = `notification ${type} show`;
                
                // Hide notification after 5 seconds
                setTimeout(() => {
                    notification.className = 'notification';
                }, 5000);
            }

            // Send command to device
            function sendCommand(command, params = {}) {
                if (!isConnected || !socket) {
                    showNotification('Not connected to device', 'error');
                    return;
                }
                
                const message = {
                    type: 'command',
                    command: command,
                    params: params,
                    timestamp: new Date().toISOString()
                };
                
                // Send command to device
                socket.send(JSON.stringify(message));
                
                // Add log entry
                addLogEntry(`Command sent: ${command}`, 'info');
            }

            // Restart device
            function restartDevice() {
                // Show confirmation dialog
                if (confirm('Are you sure you want to restart the device?')) {
                    sendCommand('restart');
                    
                    // Simulate device restarting
                    isConnected = false;
                    statusIndicator.className = 'status-indicator warning';
                    statusText.textContent = 'Restarting...';
                    connectionStatus.className = 'connection-status connecting';
                    connectionStatus.innerHTML = '<div class="connection-indicator"></div><span>Reconnecting...</span>';
                    
                    // Add log entry
                    addLogEntry('Device is restarting', 'warning');
                    
                    // Simulate reconnection after restart
                    setTimeout(() => {
                        connectWebSocket();
                    }, 5000);
                }
            }

            // Toggle theme
            function toggleTheme() {
                isDarkTheme = !isDarkTheme;
                
                if (isDarkTheme) {
                    document.body.classList.add('dark-theme');
                    themeToggle.textContent = '☀️';
                } else {
                    document.body.classList.remove('dark-theme');
                    themeToggle.textContent = '🌙';
                }
                
                // Save preference
                localStorage.setItem('darkTheme', isDarkTheme);
                
                // Update chart colors
                updateChartTheme();
            }

            // Check saved theme preference
            function checkThemePreference() {
                const savedTheme = localStorage.getItem('darkTheme');
                
                if (savedTheme === 'true') {
                    isDarkTheme = true;
                    document.body.classList.add('dark-theme');
                    themeToggle.textContent = '☀️';
                    updateChartTheme();
                }
            }

            // Update chart theme
            function updateChartTheme() {
                if (temperatureChart) {
                    temperatureChart.options.scales.x.grid.color = isDarkTheme ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                    temperatureChart.options.scales.y.grid.color = isDarkTheme ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                    temperatureChart.options.scales.x.ticks.color = isDarkTheme ? '#eee' : '#666';
                    temperatureChart.options.scales.y.ticks.color = isDarkTheme ? '#eee' : '#666';
                    temperatureChart.update();
                }
            }

            // Toggle edit mode
            function toggleEditMode() {
                isEditMode = !isEditMode;
                
                if (isEditMode) {
                    // Enter edit mode
                    editModeBtn.textContent = 'Exit Edit Mode';
                    editModeBtn.classList.remove('btn-secondary');
                    editModeBtn.classList.add('btn-warning');
                    componentToolbar.style.display = 'block';
                    
                    // Make cards draggable
                    const cards = document.querySelectorAll('.card');
                    cards.forEach(card => {
                        card.classList.add('draggable');
                        
                        // Add edit button to each card
                        const cardHeader = card.querySelector('.card-header');
                        if (cardHeader) {
                            const editBtn = document.createElement('button');
                            editBtn.className = 'btn btn-secondary edit-component';
                            editBtn.innerHTML = '⚙️';
                            editBtn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const componentId = card.getAttribute('data-component-id');
                                openComponentConfig(componentId);
                            });
                            
                            const cardActions = cardHeader.querySelector('.card-actions');
                            if (cardActions) {
                                cardActions.prepend(editBtn);
                            }
                        }
                    });
                    
                    // Add log entry
                    addLogEntry('Entered dashboard edit mode', 'info');
                } else {
                    // Exit edit mode
                    editModeBtn.textContent = 'Edit Dashboard';
                    editModeBtn.classList.remove('btn-warning');
                    editModeBtn.classList.add('btn-secondary');
                    componentToolbar.style.display = 'none';
                    
                    // Remove draggable and edit buttons
                    const cards = document.querySelectorAll('.card');
                    cards.forEach(card => {
                        card.classList.remove('draggable');
                        
                        const editBtn = card.querySelector('.edit-component');
                        if (editBtn) {
                            editBtn.remove();
                        }
                    });
                    
                    // Add log entry
                    addLogEntry('Exited dashboard edit mode', 'info');
                    
                    // Save dashboard layout
                    saveDashboardLayout();
                }
            }

            // Initialize dynamic components
            function initializeDynamicComponents() {
                // Initialize any dynamic components that were added
                document.querySelectorAll('[data-component-type]').forEach(component => {
                    initializeComponent(component);
                });
            }

            // Initialize a specific component
            function initializeComponent(component) {
                const type = component.getAttribute('data-component-type');
                
                switch (type) {
                    case 'circle-canvas':
                        initializeCircleCanvas(component);
                        break;
                    case 'chart':
                        initializeChart(component);
                        break;
                    // Add other component initializations as needed
                }
            }

            // Initialize circle canvas
            function initializeCircleCanvas(component) {
                const canvas = component.querySelector('canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const source = canvas.getAttribute('data-source');
                const min = parseInt(canvas.getAttribute('data-min') || 0);
                const max = parseInt(canvas.getAttribute('data-max') || 100);
                const colorMin = canvas.getAttribute('data-color-min') || '#4caf50';
                const colorMax = canvas.getAttribute('data-color-max') || '#f44336';
                
                // Set canvas dimensions
                canvas.width = 150;
                canvas.height = 150;
                
                // Draw initial state
                drawCircleCanvas(ctx, 0, min, max, colorMin, colorMax);
                
                // Store context for updates
                canvas._ctx = ctx;
                canvas._min = min;
                canvas._max = max;
                canvas._colorMin = colorMin;
                canvas._colorMax = colorMax;
            }

            // Draw circle canvas
            function drawCircleCanvas(ctx, value, min, max, colorMin, colorMax) {
                // Clear canvas
                ctx.clearRect(0, 0, 150, 150);
                
                // Calculate percentage
                const percentage = Math.min(1, Math.max(0, (value - min) / (max - min)));
                
                // Calculate color
                const r1 = parseInt(colorMin.slice(1, 3), 16);
                const g1 = parseInt(colorMin.slice(3, 5), 16);
                const b1 = parseInt(colorMin.slice(5, 7), 16);
                
                const r2 = parseInt(colorMax.slice(1, 3), 16);
                const g2 = parseInt(colorMax.slice(3, 5), 16);
                const b2 = parseInt(colorMax.slice(5, 7), 16);
                
                const r = Math.floor(r1 + (r2 - r1) * percentage);
                const g = Math.floor(g1 + (g2 - g1) * percentage);
                const b = Math.floor(b1 + (b2 - b1) * percentage);
                
                const color = `rgb(${r}, ${g}, ${b})`;
                
                // Draw circle
                ctx.beginPath();
                ctx.arc(75, 75, 60, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                
                // Draw text
                ctx.font = 'bold 24px Arial';
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(value, 75, 75);
            }

            // Initialize chart
            function initializeChart(component) {
                const canvas = component.querySelector('canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const source = canvas.getAttribute('data-source');
                const chartType = canvas.getAttribute('data-chart-type') || 'line';
                const timeRange = parseInt(canvas.getAttribute('data-time-range') || 10);
                
                // Generate initial data
                const labels = Array.from({length: 12}, (_, i) => {
                    const date = new Date();
                    date.setMinutes(date.getMinutes() - (11 - i) * (timeRange / 12));
                    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                });
                
                const data = Array.from({length: 12}, () => Math.floor(Math.random() * 50) + 20);
                
                // Create chart
                const chart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: source.charAt(0).toUpperCase() + source.slice(1),
                            data: data,
                            borderColor: '#2196f3',
                            backgroundColor: chartType === 'line' ? 'rgba(33, 150, 243, 0.1)' : 'rgba(33, 150, 243, 0.7)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: chartType === 'line'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    stepSize: 20
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                
                // Store chart for updates
                canvas._chart = chart;
                canvas._data = data;
            }

            // Update dynamic components with new data
            function updateDynamicComponents(data) {
                // Update text displays
                document.querySelectorAll('.text-display').forEach(display => {
                    const source = display.getAttribute('data-source');
                    const format = display.getAttribute('data-format') || '{value}';
                    
                    if (source && data[source] !== undefined) {
                        let value = data[source];
                        
                        // Handle nested properties
                        if (source.includes('.')) {
                            const parts = source.split('.');
                            value = data;
                            for (const part of parts) {
                                if (value && value[part] !== undefined) {
                                    value = value[part];
                                } else {
                                    value = 'N/A';
                                    break;
                                }
                            }
                        }
                        
                        // Format the value
                        const formattedValue = format.replace('{value}', value);
                        display.textContent = formattedValue;
                    }
                });
                
                // Update circle canvases
                document.querySelectorAll('.circle-canvas').forEach(canvas => {
                    const source = canvas.getAttribute('data-source');
                    
                    if (source && data[source] !== undefined && canvas._ctx) {
                        let value = data[source];
                        
                        // Handle nested properties
                        if (source.includes('.')) {
                            const parts = source.split('.');
                            value = data;
                            for (const part of parts) {
                                if (value && value[part] !== undefined) {
                                    value = value[part];
                                } else {
                                    value = 0;
                                    break;
                                }
                            }
                        }
                        
                        drawCircleCanvas(
                            canvas._ctx, 
                            value, 
                            canvas._min, 
                            canvas._max, 
                            canvas._colorMin, 
                            canvas._colorMax
                        );
                    }
                });
                
                // Update on/off indicators
                document.querySelectorAll('.onoff-indicator').forEach(indicator => {
                    const source = indicator.getAttribute('data-source');
                    const onText = indicator.getAttribute('data-on-text') || 'ON';
                    const offText = indicator.getAttribute('data-off-text') || 'OFF';
                    
                    if (source && data[source] !== undefined) {
                        let value = data[source];
                        
                        // Handle nested properties
                        if (source.includes('.')) {
                            const parts = source.split('.');
                            value = data;
                            for (const part of parts) {
                                if (value && value[part] !== undefined) {
                                    value = value[part];
                                } else {
                                    value = false;
                                    break;
                                }
                            }
                        }
                        
                        if (value) {
                            indicator.classList.remove('off');
                            indicator.classList.add('on');
                            indicator.textContent = onText;
                        } else {
                            indicator.classList.remove('on');
                            indicator.classList.add('off');
                            indicator.textContent = offText;
                        }
                    }
                });
                
                // Update charts
                document.querySelectorAll('canvas[data-source]').forEach(canvas => {
                    if (!canvas._chart) return;
                    
                    const source = canvas.getAttribute('data-source');
                    
                    if (source && data[source] !== undefined) {
                        let value = data[source];
                        
                        // Handle nested properties
                        if (source.includes('.')) {
                            const parts = source.split('.');
                            value = data;
                            for (const part of parts) {
                                if (value && value[part] !== undefined) {
                                    value = value[part];
                                } else {
                                    value = 0;
                                    break;
                                }
                            }
                        }
                        
                        // Add new data point
                        canvas._data.push(value);
                        if (canvas._data.length > 12) {
                            canvas._data.shift();
                        }
                        
                        // Update labels
                        const now = new Date();
                        const newLabel = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        canvas._chart.data.labels.push(newLabel);
                        if (canvas._chart.data.labels.length > 12) {
                            canvas._chart.data.labels.shift();
                        }
                        
                        // Update dataset
                        canvas._chart.data.datasets[0].data = canvas._data;
                        
                        // Update chart
                        canvas._chart.update();
                    }
                });
            }

            // Add a new component to the dashboard
            function addComponent(componentType) {
                if (!componentTemplates[componentType]) {
                    showNotification(`Unknown component type: ${componentType}`, 'error');
                    return;
                }
                
                // Generate unique ID
                const componentId = `component-${Date.now()}`;
                
                // Create card
                const card = document.createElement('div');
                card.className = 'card';
                card.setAttribute('data-component-id', componentId);
                card.setAttribute('data-component-type', componentType);
                
                // Add card header
                const cardHeader = document.createElement('div');
                cardHeader.className = 'card-header';
                cardHeader.innerHTML = `
                    <div class="card-title">${componentTemplates[componentType].title}</div>
                    <div class="card-actions">
                        <button class="btn btn-secondary edit-component">⚙️</button>
                    </div>
                `;
                
                // Add card content
                const cardContent = document.createElement('div');
                cardContent.className = 'card-content';
                cardContent.innerHTML = componentTemplates[componentType].content;
                
                // Assemble card
                card.appendChild(cardHeader);
                card.appendChild(cardContent);
                
                // Add to dashboard
                dashboardGrid.appendChild(card);
                
                // Add event listener for edit button
                const editBtn = card.querySelector('.edit-component');
                if (editBtn) {
                    editBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        openComponentConfig(componentId);
                    });
                }
                
                // Initialize the component
                initializeComponent(card);
                
                // Open configuration modal
                openComponentConfig(componentId);
                
                // Add log entry
                addLogEntry(`Added new ${componentTemplates[componentType].title} component`, 'info');
            }

            // Open component configuration modal
            function openComponentConfig(componentId) {
                const component = document.querySelector(`[data-component-id="${componentId}"]`);
                if (!component) return;
                
                const componentType = component.getAttribute('data-component-type');
                if (!componentType || !componentTemplates[componentType]) return;
                
                // Set current component
                currentComponent = {
                    id: componentId,
                    type: componentType,
                    element: component
                };
                
                // Set modal title
                modalTitle.textContent = `Configure ${componentTemplates[componentType].title}`;
                
                // Clear form
                configForm.innerHTML = '';
                
                // Add configuration fields
                componentTemplates[componentType].config.forEach(field => {
                    const formGroup = document.createElement('div');
                    formGroup.style.marginBottom = '15px';
                    
                    const label = document.createElement('label');
                    label.textContent = field.label;
                    label.setAttribute('for', `config-${field.name}`);
                    
                    let input;
                    
                    switch (field.type) {
                        case 'text':
                        case 'number':
                        case 'color':
                            input = document.createElement('input');
                            input.type = field.type;
                            input.id = `config-${field.name}`;
                            input.name = field.name;
                            input.value = field.default;
                            break;
                            
                        case 'select':
                            input = document.createElement('select');
                            input.id = `config-${field.name}`;
                            input.name = field.name;
                            
                            field.options.forEach(option => {
                                const optionEl = document.createElement('option');
                                optionEl.value = option.value;
                                optionEl.textContent = option.label;
                                if (option.value === field.default) {
                                    optionEl.selected = true;
                                }
                                input.appendChild(optionEl);
                            });
                            break;
                            
                        case 'checkbox':
                            input = document.createElement('input');
                            input.type = 'checkbox';
                            input.id = `config-${field.name}`;
                            input.name = field.name;
                            input.checked = field.default;
                            break;
                            
                        case 'textarea':
                            input = document.createElement('textarea');
                            input.id = `config-${field.name}`;
                            input.name = field.name;
                            input.value = field.default;
                            input.rows = 4;
                            break;
                    }
                    
                    // Get current value if component already exists
                    if (component) {
                        const cardTitle = component.querySelector('.card-title');
                        if (cardTitle && field.name === 'title') {
                            input.value = cardTitle.textContent;
                        }
                        
                        const contentElement = component.querySelector(`[data-${field.name}]`);
                        if (contentElement) {
                            const value = contentElement.getAttribute(`data-${field.name}`);
                            if (value) {
                                if (field.type === 'checkbox') {
                                    input.checked = value === 'true';
                                } else {
                                    input.value = value;
                                }
                            }
                        }
                    }
                    
                    formGroup.appendChild(label);
                    formGroup.appendChild(input);
                    configForm.appendChild(formGroup);
                });
                
                // Show modal
                configModal.classList.add('show');
            }

            // Save component configuration
            function saveComponentConfig() {
                if (!currentComponent) return;
                
                const component = currentComponent.element;
                const componentType = currentComponent.type;
                
                // Get form values
                const formData = {};
                componentTemplates[componentType].config.forEach(field => {
                    const input = document.getElementById(`config-${field.name}`);
                    if (input) {
                        if (field.type === 'checkbox') {
                            formData[field.name] = input.checked;
                        } else {
                            formData[field.name] = input.value;
                        }
                    }
                });
                
                // Update component title
                const cardTitle = component.querySelector('.card-title');
                if (cardTitle && formData.title) {
                    cardTitle.textContent = formData.title;
                }
                
                // Update component content based on type
                switch (componentType) {
                    case 'text-display':
                        updateTextDisplay(component, formData);
                        break;
                    case 'circle-canvas':
                        updateCircleCanvas(component, formData);
                        break;
                    case 'onoff-indicator':
                        updateOnOffIndicator(component, formData);
                        break;
                    case 'gauge':
                        updateGauge(component, formData);
                        break;
                    case 'chart':
                        updateChart(component, formData);
                        break;
                    case 'text-input':
                        updateTextInput(component, formData);
                        break;
                    case 'switch-button':
                        updateSwitchButton(component, formData);
                        break;
                    case 'slider':
                        updateSlider(component, formData);
                        break;
                    case 'select-dropdown':
                        updateSelectDropdown(component, formData);
                        break;
                    case 'push-button':
                        updatePushButton(component, formData);
                        break;
                    case 'automation-rule':
                        updateAutomationRule(component, formData);
                        break;
                }
                
                // Close modal
                configModal.classList.remove('show');
                
                // Reset current component
                currentComponent = null;
                
                // Show notification
                showNotification('Component configuration saved', 'success');
                
                // Update with current data
                if (currentDeviceData) {
                    updateDynamicComponents(currentDeviceData);
                }
            }

            // Update text display component
            function updateTextDisplay(component, config) {
                const display = component.querySelector('.text-display');
                if (!display) return;
                
                display.setAttribute('data-source', config.source);
                display.setAttribute('data-format', config.format);
                
                // Update with current data if available
                if (currentDeviceData && currentDeviceData[config.source] !== undefined) {
                    let value = currentDeviceData[config.source];
                    const formattedValue = config.format.replace('{value}', value);
                    display.textContent = formattedValue;
                }
            }

            // Update circle canvas component
            function updateCircleCanvas(component, config) {
                const canvas = component.querySelector('canvas');
                if (!canvas) return;
                
                canvas.setAttribute('data-source', config.source);
                canvas.setAttribute('data-min', config.min);
                canvas.setAttribute('data-max', config.max);
                canvas.setAttribute('data-color-min', config.colorMin);
                canvas.setAttribute('data-color-max', config.colorMax);
                
                // Reinitialize canvas
                initializeCircleCanvas(component);
                
                // Update with current data if available
                if (currentDeviceData && currentDeviceData[config.source] !== undefined) {
                    let value = currentDeviceData[config.source];
                    drawCircleCanvas(
                        canvas._ctx, 
                        value, 
                        canvas._min, 
                        canvas._max, 
                        canvas._colorMin, 
                        canvas._colorMax
                    );
                }
            }

            // Update on/off indicator component
            function updateOnOffIndicator(component, config) {
                const indicator = component.querySelector('.onoff-indicator');
                if (!indicator) return;
                
                indicator.setAttribute('data-source', config.source);
                indicator.setAttribute('data-on-text', config.onText);
                indicator.setAttribute('data-off-text', config.offText);
                
                // Update with current data if available
                if (currentDeviceData && currentDeviceData[config.source] !== undefined) {
                    let value = currentDeviceData[config.source];
                    
                    if (value) {
                        indicator.classList.remove('off');
                        indicator.classList.add('on');
                        indicator.textContent = config.onText;
                    } else {
                        indicator.classList.remove('on');
                        indicator.classList.add('off');
                        indicator.textContent = config.offText;
                    }
                }
            }

            // Update gauge component
            function updateGauge(component, config) {
                const gauge = component.querySelector('.gauge');
                const gaugeFill = component.querySelector('.gauge-fill');
                const gaugeValue = component.querySelector('.gauge-value');
                const gaugeLabel = component.querySelector('.gauge-label');
                
                if (!gauge || !gaugeFill || !gaugeValue || !gaugeLabel) return;
                
                gauge.setAttribute('data-source', config.source);
                gauge.setAttribute('data-min', config.min);
                gauge.setAttribute('data-max', config.max);
                gaugeLabel.textContent = config.label;
                
                // Update with current data if available
                if (currentDeviceData && currentDeviceData[config.source] !== undefined) {
                    let value = currentDeviceData[config.source];
                    const min = parseInt(config.min);
                    const max = parseInt(config.max);
                    const percentage = Math.min(100, Math.max(0, ((value - min) / (max - min)) * 100));
                    
                    gaugeFill.style.height = percentage + '%';
                    gaugeValue.textContent = value;
                }
            }

            // Update chart component
            function updateChart(component, config) {
                const canvas = component.querySelector('canvas');
                if (!canvas) return;
                
                // Destroy existing chart if it exists
                if (canvas._chart) {
                    canvas._chart.destroy();
                }
                
                canvas.setAttribute('data-source', config.source);
                canvas.setAttribute('data-chart-type', config.chartType);
                canvas.setAttribute('data-time-range', config.timeRange); 
                canvas.setAttribute('data-time-range', config.timeRange);
                
                // Initialize new chart
                initializeChart(component);
            }

            // Update text input component
            function updateTextInput(component, config) {
                const controlItem = component.querySelector('.control-item');
                if (!controlItem) return;
                
                const label = controlItem.querySelector('.control-label');
                const input = controlItem.querySelector('.text-input');
                
                if (label) label.textContent = config.label;
                
                if (input) {
                    input.setAttribute('data-target', config.target);
                    input.setAttribute('placeholder', config.placeholder);
                }
            }

            // Update switch button component
            function updateSwitchButton(component, config) {
                const controlItem = component.querySelector('.control-item');
                if (!controlItem) return;
                
                const label = controlItem.querySelector('.control-label');
                const input = controlItem.querySelector('input[type="checkbox"]');
                
                if (label) label.textContent = config.label;
                
                if (input) {
                    input.setAttribute('data-target', config.target);
                    input.checked = config.defaultState;
                    
                    // Add event listener if not already added
                    if (!input._hasListener) {
                        input.addEventListener('change', function() {
                            sendCommand(this.getAttribute('data-target'), { state: this.checked });
                        });
                        input._hasListener = true;
                    }
                }
            }

            // Update slider component
            function updateSlider(component, config) {
                const controlItem = component.querySelector('.control-item');
                if (!controlItem) return;
                
                const label = controlItem.querySelector('.control-label');
                const slider = controlItem.querySelector('.range-slider');
                const value = controlItem.querySelector('.range-value');
                
                if (label) label.textContent = config.label;
                
                if (slider) {
                    slider.setAttribute('data-target', config.target);
                    slider.min = config.min;
                    slider.max = config.max;
                    slider.value = config.default;
                    
                    // Update value display
                    if (value) value.textContent = config.default + '%';
                    
                    // Add event listener if not already added
                    if (!slider._hasListener) {
                        slider.addEventListener('input', function() {
                            const valueDisplay = this.parentNode.querySelector('.range-value');
                            if (valueDisplay) valueDisplay.textContent = this.value + '%';
                        });
                        
                        slider.addEventListener('change', function() {
                            sendCommand(this.getAttribute('data-target'), { value: parseInt(this.value) });
                        });
                        
                        slider._hasListener = true;
                    }
                }
            }

            // Update select dropdown component
            function updateSelectDropdown(component, config) {
                const controlItem = component.querySelector('.control-item');
                if (!controlItem) return;
                
                const label = controlItem.querySelector('.control-label');
                const select = controlItem.querySelector('select');
                
                if (label) label.textContent = config.label;
                
                if (select) {
                    select.setAttribute('data-target', config.target);
                    
                    // Clear existing options
                    select.innerHTML = '';
                    
                    // Add new options
                    const options = config.options.split('\n');
                    options.forEach(option => {
                        if (option.trim()) {
                            const [value, label] = option.split(':');
                            const optionEl = document.createElement('option');
                            optionEl.value = value.trim();
                            optionEl.textContent = label ? label.trim() : value.trim();
                            select.appendChild(optionEl);
                        }
                    });
                    
                    // Add event listener if not already added
                    if (!select._hasListener) {
                        select.addEventListener('change', function() {
                            sendCommand(this.getAttribute('data-target'), { value: this.value });
                        });
                        select._hasListener = true;
                    }
                }
            }

            // Update push button component
            function updatePushButton(component, config) {
                const controlItem = component.querySelector('.control-item');
                if (!controlItem) return;
                
                const label = controlItem.querySelector('.control-label');
                const button = controlItem.querySelector('button');
                
                if (label) label.textContent = config.label;
                
                if (button) {
                    button.textContent = config.buttonText;
                    button.setAttribute('data-target', config.target);
                    button.setAttribute('data-confirm', config.confirm);
                    
                    // Update button style
                    button.className = `btn ${config.buttonStyle}`;
                    
                    // Add event listener if not already added
                    if (!button._hasListener) {
                        button.addEventListener('click', function() {
                            const target = this.getAttribute('data-target');
                            const requireConfirm = this.getAttribute('data-confirm') === 'true';
                            
                            if (requireConfirm) {
                                if (confirm(`Are you sure you want to execute the ${target} command?`)) {
                                    sendCommand(target);
                                }
                            } else {
                                sendCommand(target);
                            }
                        });
                        button._hasListener = true;
                    }
                }
            }

            // Update automation rule component
            function updateAutomationRule(component, config) {
                const rule = component.querySelector('.automation-rule');
                if (!rule) return;
                
                const inputDevice = rule.querySelector('.input-device');
                const condition = rule.querySelector('.condition');
                const threshold = rule.querySelector('.threshold');
                const outputAction = rule.querySelector('.output-action');
                const actionValue = rule.querySelector('.action-value');
                
                if (inputDevice) inputDevice.value = config.inputDevice;
                if (condition) condition.value = config.condition;
                if (threshold) threshold.value = config.threshold;
                if (outputAction) outputAction.value = config.outputAction;
                if (actionValue) actionValue.value = config.actionValue;
            }

            // Add automation rule
            function addAutomationRule() {
                const ruleTemplate = `
                    <div class="automation-rule">
                        <select class="input-device">
                            <option value="">Select Input</option>
                            <option value="temperature">Temperature</option>
                            <option value="cpuUsage">CPU Usage</option>
                            <option value="memoryUsage">Memory Usage</option>
                        </select>
                        <select class="condition">
                            <option value="gt">Greater Than</option>
                            <option value="lt">Less Than</option>
                            <option value="eq">Equal To</option>
                        </select>
                        <input type="number" class="threshold" value="80">
                        <select class="output-action">
                            <option value="">Select Action</option>
                            <option value="power">Toggle Power</option>
                            <option value="fanSpeed">Set Fan Speed</option>
                            <option value="mode">Change Mode</option>
                        </select>
                        <input type="text" class="action-value" placeholder="Value">
                        <button class="delete-rule">×</button>
                    </div>
                `;
                
                // Add rule to container
                automationRules.insertAdjacentHTML('beforeend', ruleTemplate);
                
                // Add event listener to delete button
                const deleteBtn = automationRules.lastElementChild.querySelector('.delete-rule');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        this.closest('.automation-rule').remove();
                    });
                }
                
                // Add log entry
                addLogEntry('Added new automation rule', 'info');
            }

            // Check automation rules against current data
            function checkAutomationRules(data) {
                document.querySelectorAll('.automation-rule').forEach(rule => {
                    const inputDevice = rule.querySelector('.input-device').value;
                    const condition = rule.querySelector('.condition').value;
                    const threshold = parseFloat(rule.querySelector('.threshold').value);
                    const outputAction = rule.querySelector('.output-action').value;
                    const actionValue = rule.querySelector('.action-value').value;
                    
                    // Skip if not fully configured
                    if (!inputDevice || !condition || !outputAction) return;
                    
                    // Get input value
                    let inputValue = data[inputDevice];
                    if (inputValue === undefined) return;
                    
                    // Check condition
                    let conditionMet = false;
                    switch (condition) {
                        case 'gt':
                            conditionMet = inputValue > threshold;
                            break;
                        case 'lt':
                            conditionMet = inputValue < threshold;
                            break;
                        case 'eq':
                            conditionMet = inputValue === threshold;
                            break;
                    }
                    
                    // Execute action if condition is met
                    if (conditionMet) {
                        executeAutomationAction(outputAction, actionValue, inputDevice, threshold);
                    }
                });
            }

            // Execute automation action
            function executeAutomationAction(action, value, trigger, threshold) {
                switch (action) {
                    case 'power':
                        // Toggle power
                        const newPowerState = value === 'on' || value === 'true' || value === '1';
                        powerToggle.checked = newPowerState;
                        sendCommand('power', { state: newPowerState });
                        addLogEntry(`Automation: Set power to ${newPowerState ? 'ON' : 'OFF'} (Trigger: ${trigger} ${threshold})`, 'info');
                        break;
                        
                    case 'fanSpeed':
                        // Set fan speed
                        const speed = parseInt(value) || 50;
                        fanSpeedSlider.value = speed;
                        fanSpeedValue.textContent = speed + '%';
                        sendCommand('fanSpeed', { value: speed });
                        addLogEntry(`Automation: Set fan speed to ${speed}% (Trigger: ${trigger} ${threshold})`, 'info');
                        break;
                        
                    case 'mode':
                        // Change mode
                        if (value && modeSelect.querySelector(`option[value="${value}"]`)) {
                            modeSelect.value = value;
                            sendCommand('setMode', { mode: value });
                            addLogEntry(`Automation: Changed mode to ${value} (Trigger: ${trigger} ${threshold})`, 'info');
                        }
                        break;
                }
            }

            // Save dashboard layout
            function saveDashboardLayout() {
                // In a real application, you would save the layout to localStorage or server
                addLogEntry('Dashboard layout saved', 'success');
                showNotification('Dashboard layout saved', 'success');
            }

            // Set up event listeners
            function setupEventListeners() {
                // Refresh button
                refreshBtn.addEventListener('click', function() {
                    updateDeviceData();
                    showNotification('Data refreshed');
                });
                
                // Temperature time range
                tempTimeRange.addEventListener('click', function() {
                    // Toggle between time ranges
                    if (this.textContent === 'Last Hour') {
                        this.textContent = 'Last Day';
                    } else if (this.textContent === 'Last Day') {
                        this.textContent = 'Last Week';
                    } else {
                        this.textContent = 'Last Hour';
                    }
                    
                    // In a real app, you would fetch data for the selected time range
                    showNotification(`Showing data for ${this.textContent.toLowerCase()}`);
                });
                
                // Fan speed slider
                fanSpeedSlider.addEventListener('input', function() {
                    fanSpeedValue.textContent = this.value + '%';
                });
                
                fanSpeedSlider.addEventListener('change', function() {
                    sendCommand('fanSpeed', { value: parseInt(this.value) });
                });
                
                // Power toggle
                powerToggle.addEventListener('change', function() {
                    if (this.checked) {
                        sendCommand('power', { state: 'on' });
                    } else {
                        sendCommand('power', { state: 'off' });
                    }
                });
                
                // Mode select
                modeSelect.addEventListener('change', function() {
                    sendCommand('setMode', { mode: this.value });
                    addLogEntry(`Mode changed to ${this.value}`, 'info');
                });
                
                // Restart button
                restartBtn.addEventListener('click', function() {
                    restartDevice();
                });
                
                // Clear log button
                clearLogBtn.addEventListener('click', function() {
                    eventLog.innerHTML = '';
                    addLogEntry('Event log cleared', 'info');
                });
                
                // Save controls button
                saveControlsBtn.addEventListener('click', function() {
                    const controls = {
                        power: powerToggle.checked,
                        fanSpeed: parseInt(fanSpeedSlider.value),
                        mode: modeSelect.value
                    };
                    
                    sendCommand('saveControls', controls);
                    showNotification('Control settings saved');
                });
                
                // Delete rule buttons
                document.querySelectorAll('.delete-rule').forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.closest('.automation-rule').remove();
                    });
                });
            }
        })
    </script>
</body>
</html>